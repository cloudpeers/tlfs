on:
  release:
    types:
    - created

name: release tlfs

jobs:
  tlfsc_linux:
    runs-on: self-hosted
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2

    - name: Install rust toolchain
      uses: hecrj/setup-rust-action@v1

    - name: Install jq
      uses: sergeysova/jq-action@v2

    - name: Build tlfsc
      working-directory: tlfsc
      run: cargo build --release

    - name: Upload tlfsc
      working-directory: target/release
      env:
        TAG: $(cat $GITHUB_EVENT_PATH | jq .release.tag_name)
      run: gh $TAG release upload tlfsc -R $GITHUB_REPOSITORY --clobber

  tlfs_linux:
    runs-on: self-hosted
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2

    - name: Install rust toolchain
      uses: hecrj/setup-rust-action@v1

    - name: Install jq
      uses: sergeysova/jq-action@v2

    - name: Build tlfs
      working-directory: api
      run: cargo build --release

    - name: Upload tlfs
      working-directory: target/release
      env:
        TAG: $(cat $GITHUB_EVENT_PATH | jq .release.tag_name)
      run: gh $TAG release upload libtlfs.so#x86_64-unknown-linux-gnu -R $GITHUB_REPOSITORY --clobber

  tlfs_android:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout sources
      uses: actions/checkout@v2

    - name: Install rust toolchain
      uses: hecrj/setup-rust-action@v1
      with:
        targets: aarch64-linux-android

    - name: Install cargo apk
      run: cargo install cargo-apk

    - name: Install jq
      uses: sergeysova/jq-action@v2

    - name: Build tlfs
      working-directory: api
      continue-on-error: true # currently this fails as cargo-apk ignores the [lib] name setting
      run: cargo apk build --release --target aarch64-linux-android

    - name: Upload tlfs
      working-directory: target/aarch64-linux-android/release
      env:
        TAG: $(cat $GITHUB_EVENT_PATH | jq .release.tag_name)
      run: gh $TAG release upload libtlfs.so#aarch64-linux-android -R $GITHUB_REPOSITORY --clobber
